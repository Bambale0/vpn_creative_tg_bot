# Настройка сервиса VPN Telegram Bot

## Создание виртуального окружения и установка зависимостей

Виртуальное окружение уже создано в папке `venv` и зависимости установлены.

```bash
# Активация виртуального окружения
source venv/bin/activate

# Установка зависимостей (уже выполнена)
pip install -r requirements.txt
```

## Настройка сервис файла

Сервис файл `service_files/vpnbot.service` настроен для работы с текущей структурой проекта:

- **WorkingDirectory**: `/root/vpnbot_consolidated`
- **ExecStart**: `/root/vpnbot_consolidated/venv/bin/python /root/vpnbot_consolidated/service_files/start_webhook_bot.py`
- **Логирование**: `/root/vpnbot_consolidated/logs/service.log`

## Установка сервиса

1. Скопируйте сервис файл в системную директорию:
```bash
sudo cp service_files/vpnbot.service /etc/systemd/system/
```

2. Перезагрузите демон systemd:
```bash
sudo systemctl daemon-reload
```

3. Включите сервис для автозапуска:
```bash
sudo systemctl enable vpnbot.service
```

4. Запустите сервис:
```bash
sudo systemctl start vpnbot.service
```

## Проверка статуса сервиса

```bash
# Проверить статус сервиса
sudo systemctl status vpnbot.service

# Просмотр логов сервиса
sudo journalctl -u vpnbot.service -f

# Остановка сервиса
sudo systemctl stop vpnbot.service

# Перезапуск сервиса
sudo systemctl restart vpnbot.service
```

## Проверка конфигурации

Конфигурация проекта проверена и валидирована:
- ✅ Виртуальное окружение создано
- ✅ Зависимости установлены
- ✅ Пути в конфигурационных файлах исправлены
- ✅ Сервис файл настроен правильно

## Структура путей проекта

- **Корневая директория**: `/root/vpnbot_consolidated`
- **Конфигурация**: `config/config.py`
- **Данные**: `data/`
- **Логи**: `logs/`
- **SSL сертификаты**: `ssl/`
- **Статические файлы**: `static/`
- **Шаблоны**: `templates/`

## Переменные окружения

Основные настройки хранятся в файле `.env`. Пример конфигурации в `.env.example`.

## Новые функции безопасности и производительности

### Rate Limiting для Callback запросов

Внедрено ограничение частоты callback запросов от пользователей:
- Максимум 10 callback запросов в секунду на пользователя
- Предотвращает спам и DDoS атаки через callback API
- Реализуется с использованием библиотеки `aiolimiter`

### Connection Pooling для базы данных

Добавлен пул соединений для SQLite базы данных:
- Улучшает производительность при высокой нагрузке
- Автоматическое управление соединениями
- Корректное закрытие соединений при остановке сервиса

### Система алертов для администраторов

Внедрена система уведомлений для критических событий:
- Алтеры о критических ошибках
- Уведомления о проблемах безопасности
- Предупреждения о производительности
- Сообщения отправляются администраторам через Telegram

## Deployment с использованием Docker

### Требования

- Docker
- Docker Compose

### Быстрый старт

1. Установите переменные окружения в файле `.env`
2. Создайте директории: `mkdir -p data logs ssl`
3. Запустите сервисы:
```bash
./deploy.sh start
```

### Управление службами

```bash
# Проверить статус
./deploy.sh status

# Просмотреть логи
./deploy.sh logs

# Остановить все сервисы
./deploy.sh stop

# Перезапустить сервисы
./deploy.sh restart

# Обновить и перезапустить
./deploy.sh update

# Очистить неиспользуемые ресурсы
./deploy.sh cleanup
```

### Структура сервисов в Docker Compose

- **vpnbot**: Основной бот с вебхуками
- **webapp**: Web интерфейс для администратора
- **nginx**: Прокси-сервер с SSL
- **wireguard**: VPN сервер (опционально)

## Примечания

- Сервис настроен для работы в режиме вебхуков
- Используется виртуальное окружение Python для изоляции зависимостей
- Логирование настроено в файлы в папке `logs/`
- Сервис автоматически перезапускается при сбоях
- Добавлена система rate limiting и мониторинга безопасности
- Поддерживается контейнеризированное развертывание
