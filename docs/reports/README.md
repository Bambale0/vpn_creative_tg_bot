# Система управления подписками бота

Ядрен батон, да как так то! Это интересная задача, поэтому нужно хапнуть!

## Описание

Система для автоматической проверки и очистки истекших подписок пользователей бота. Деактивирует пользователей с истекшими триалами и премиум-подписками, очищает их конфиги, чтобы они не могли пользоваться ботом без оплаты.

## Функциональность

- ✅ Проверка истекших подписок в базе данных
- ✅ Автоматическая деактивация пользователей с истекшими подписками
- ✅ Очистка конфигов пользователей
- ✅ Логирование всех действий
- ✅ Статистика подписок
- ✅ Автоматический запуск по расписанию
- ✅ Тестирование системы

## Структура базы данных

### Таблица `users`
- `user_id` - уникальный идентификатор пользователя
- `username` - имя пользователя
- `subscription_type` - тип подписки ('trial', 'premium', etc.)
- `subscription_start` - дата начала подписки
- `subscription_end` - дата окончания подписки
- `is_active` - активен ли пользователь (1 - активен, 0 - деактивирован)
- `config_data` - конфигурационные данные пользователя
- `created_at` - дата создания записи

### Таблица `cleanup_log`
- `id` - уникальный идентификатор записи
- `user_id` - ID пользователя
- `action` - выполненное действие
- `timestamp` - время действия
- `details` - подробности действия

## Файлы проекта

- `simple_subscription_manager.py` - основной менеджер подписок
- `test_subscription_manager.py` - тестовый скрипт
- `auto_cleanup.py` - автоматический запуск по расписанию
- `requirements.txt` - зависимости проекта

## Установка и настройка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите инициализацию базы данных:
```bash
python simple_subscription_manager.py
```

3. Для тестирования системы:
```bash
python test_subscription_manager.py
```

## Использование

### Ручная очистка
```bash
python simple_subscription_manager.py
```

### Автоматическая очистка по расписанию
```bash
python auto_cleanup.py
```
Очистка выполняется ежедневно в 02:00. Можно изменить расписание в коде.

### Тестирование
```bash
python test_subscription_manager.py
```

## Примеры использования в коде

```python
from simple_subscription_manager import SubscriptionManager

# Создание менеджера
manager = SubscriptionManager(db_path='your_database.db')

# Инициализация БД
manager.init_database()

# Запуск очистки
success = manager.run_cleanup()

# Получение статистики
stats = manager.get_subscription_stats()
print(f"Активных пользователей: {stats['active_users']}")
```

## Логирование

Все действия записываются в:
- Консоль (при запуске)
- `subscription_cleanup.log` - детальные логи очистки
- `auto_cleanup.log` - логи автоматического планировщика
- Таблица `cleanup_log` в базе данных

## Безопасность

- Все операции выполняются в транзакциях
- При ошибках транзакции откатываются
- Подробное логирование всех действий
- Безопасная работа с базой данных

## Расписание

По умолчанию очистка запускается:
- При первом запуске `auto_cleanup.py`
- Ежедневно в 02:00

Можно изменить в файле `auto_cleanup.py`:
```python
# Каждые 6 часов
schedule.every(6).hours.do(run_scheduled_cleanup)

# Каждые 30 минут
schedule.every(30).minutes.do(run_scheduled_cleanup)

# Каждый понедельник в 9:00
schedule.every().monday.at("09:00").do(run_scheduled_cleanup)
```

## Мониторинг

После каждой очистки выводится статистика:
- Общее количество пользователей
- Количество активных пользователей
- Количество пользователей с триалом
- Количество подписок, истекающих в ближайшие 24 часа

## Поддержка

При возникновении проблем проверьте:
1. Логи в файлах `subscription_cleanup.log` и `auto_cleanup.log`
2. Структуру базы данных
3. Права доступа к файлам и базе данных

И так сойдет! Система готова к работе.
